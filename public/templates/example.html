<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Geetest Verification | TGPaimonBot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/gt.js" type="text/javascript"></script>
</head>
<body>
<div class="max-w-screen max-h-screen">
    <div class="container flex flex-col max-w-md mx-auto">
        <div class="flex flex-col w-full h-full items-center">
            <!--Icon-->
            <div class="flex mx-auto my-8 items-center">
                <img src="/img/PaimonBot.jpg" alt="PaimonBot icon" class="w-16 h-16 rounded-full"/>
            </div>
            <!--Title-->
            <h1 class="flex flex-col mb-4 text-lg tracking-wider">
                GeeTest Verification
            </h1>
            <!--Validation Box-->
            <div class="max-w-xs p-4 flex flex-col items-center bg-gray-50 rounded-xl border border-1 w-full h-full">
                <div class="w-full">
                    <label class="block">
                        <span class="block mb-1 text-md font-light tracking-wider text-slate-700">UID</span>
                        <input
                                type="text"
                                placeholder="{{ user.uid }}"
                                disabled
                                class="px-3 py-2 w-full text-sm rounded-md border border-slate-300 place-holder-slate-400"/>
                    </label>
                </div>
                <div id="success" class="py-1 text-green-500 text-xs" style="display: none"></div>
                <div id="error" class="py-1 text-red-500 text-xs" style="display: none"></div>
                <button id="submit"
                        class="mt-2 px-4 py-2 rounded-full bg-green-500 text-slate-100 text-sm hover:bg-green-700">
                    开始验证
                </button>
                <script>
                    var submitButton = document.getElementById("submit");
                    window.initGeetest({
                        gt: "{{ geetest.gt }}",
                        challenge: "{{ geetest.challenge }}",
                        offline: false,
                        https: true,
                        product: "bind",
                    }, function(captcha) {
                        var submitButton = document.getElementById("submit");
                        captcha.appendTo(submitButton);
                        captcha.onSuccess(function() {
                            var result = captcha.getValidate();
                            submitButton.style = "display: none";
                            console.log("Success: " + result.geetest_validate);
                            copyText("/sign " + result.geetest_validate);
                            document.getElementById("success").innerHTML = "验证成功，如果使用代理请等待页面自动跳转，否则请直接将剪贴板的命令发送给 Bot";
                            document.getElementById("success").style = "";
                            document.getElementById("error").style = "display: none";
                            window.location.href = "https://t.me/" + "{{ user.username }}" + "?start=challenge_" + result.geetest_validate;
                        });
                        captcha.onError(function(error) {
                            console.log("Error during captcha validation");
                            console.error(error);
                            submitButton.style = "display: none";
                            var msg = (error !== undefined) ? error.msg : "unknown error";
                            document.getElementById("error").innerHTML = "发生错误: " + msg;
                            document.getElementById("error").style = "";
                            document.getElementById("success").style = "display: none";
                        });
                        submitButton.onclick = function() {
                            captcha.verify();
                            document.getElementById("success").style = "display: none";
                            document.getElementById("error").style = "display: none";
                        };
                    });
                </script>
                <script type="text/javascript">
                    function copyText(text) {
                        var textareaC = document.createElement('textarea');
                        textareaC.setAttribute('readonly', 'readonly');
                        textareaC.value = text;
                        document.body.appendChild(textareaC);
                        textareaC.select();
                        var res = document.execCommand('copy');
                        document.body.removeChild(textareaC);
                        console.log("复制成功");
                        return res;
                    }
                </script>
            </div>
        </div>
    </div>
</div>
</body>
</html>
